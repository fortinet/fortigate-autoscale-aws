AWSTemplateFormatVersion: 2010-09-09
Description: >-
    This template does the majority of the work for deploying FortiGate
    Autoscale. It is not for direct use.
Parameters:
    ResourceTagPrefix:
        Type: String
        AllowedPattern: '[0-9a-zA-Z@.#-]+'
        MaxLength: 64
        ConstraintDescription: >-
            Resource tag prefix can include numbers, lowercase letters,
            uppercase letters, ampersat(@) , hyphens (-), period (.), and hash
            (#). Max length is 64.
        Description: >-
            The ResourceGroup Tag Key used on all resources and as the name
            prefix of all applicable resources. Can only contain numbers,
            lowercase letters, uppercase letters, ampersat(@), hyphens (-),
            period (.), and hash (#). Max length is 64.
    CustomIdentifier:
        Type: String
        Default: fgtASG
        MaxLength: '10'
        AllowedPattern: '[A-Za-z0-9]+'
        ConstraintDescription: must only contain uppercase and lowercase letters and numbers
        Description: >-
            An alternative name prefix to be used on a resource that the
            'Resource tag prefix' cannot apply to. Can only contain numbers,
            lowercase letters, and uppercase letters. Max length is 10.
    S3BucketName:
        Type: String
        AllowedPattern: '^[0-9a-zA-Z]+([0-9a-zA-Z-.]*[0-9a-zA-Z])*$'
        ConstraintDescription: >-
            Deployment resource S3 bucket name can include numbers, lowercase
            letters, uppercase letters, and hyphens (-). It cannot start or end
            with a hyphen (-).
        Description: >-
            Name of the S3 bucket that contains the FortiGate Autoscale
            deployment package. Can only contain numbers, lowercase letters,
            uppercase letters, and hyphens (-). It cannot start or end with a
            hyphen (-).
    S3KeyPrefix:
        Type: String
        AllowedPattern: '^[0-9a-zA-Z-./]*$'
        ConstraintDescription: >-
            Deployment package S3 key prefix can include numbers, lowercase
            letters, uppercase letters, hyphens (-), and forward slash (/).
        Description: >-
            Name of the S3 folder that stores the FortiGate Autoscale deployment
            resources. Can only contain numbers, lowercase letters, uppercase
            letters, hyphens (-), and forward slashes (/). If provided, it must
            end with a forward slash (/).
    UniqueId:
        Type: String
        MaxLength: '8'
        AllowedPattern: '[A-Za-z0-9]+'
        ConstraintDescription: must only contain uppercase and lowercase letters and digits
        Description: >-
            An automatically generated random string as a unique ID for all
            resources in the deployment stack and nested stacks.
    VpcId:
        Type: 'AWS::EC2::VPC::Id'
        Description: >-
            The ID of the existing VPC where FortiGate Autoscale will be
            deployed. The VPC must have the option 'DNS hostnames' enabled and
            each of the two AZs in the VPC must have at least 1 public subnet
            and at least 1 private subnet.
    VpcCidr:
        Type: String
        AllowedPattern: >-
            ^(([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]){1}(\/([0-9]|[1-2][0-9]|3[0-2]))?$
        ConstraintDescription: must be a valid CIDR block format.
        Description: >-
            The CIDR block of the selected existing VPC. This can be found in
            parentheses in the VPC ID parameter selection.
    VpcEndpointId:
        Type: String
        Description: >-
            Specify the ID of the Private VPC Endpoint associated with the
            existing VPC. This parameter is required when deploying with an
            existing VPC. The Private VPC Endpoint is a VPC Endpoint that has
            enabled the 'Private DNS names'.
    PublicSubnet1:
        Type: 'AWS::EC2::Subnet::Id'
        Description: >-
            The ID of the public subnet 1 located in Availability Zone 1 of the
            selected existing VPC.
    PublicSubnet2:
        Type: 'AWS::EC2::Subnet::Id'
        Description: >-
            The ID of the public subnet 2 located in Availability Zone 2 of the
            selected existing VPC.
    PrivateSubnet1:
        Type: String
        Default: ''
        Description: >-
            The ID of the private subnet 1 located in Availability Zone 1 of the
            selected existing VPC. This subnet will be protected by the
            FortiGates in the public subnet of the same AZ.
    PrivateSubnet2:
        Type: String
        Default: ''
        Description: >-
            The ID of the private subnet 2 located in Availability Zone 2 of the
            selected existing VPC. This subnet will be protected by the
            FortiGates in the public subnet of the same AZ.
    PrivateSubnetRouteTable:
        Type: String
        Default: ''
        Description: Route table ID associated with the two private subnets.
    FortiGateInstanceType:
        Type: String
        Description: >-
            Instance type for the FortiGates in the Auto Scaling group. There
            are t2.small and compute-optimized instances such as c4 and c5
            available with different vCPU sizes and bandwidths. For more
            information about instance types, see
            https://aws.amazon.com/ec2/instance-types/.
    FortiOSVersion:
        Type: String
        Description: FortiOS version.
    LifecycleHookTimeout:
        Type: Number
        Default: 480
        MinValue: 60
        MaxValue: 3600
        ConstraintDescription: must be a valid number between 60 and 3600.
        Description: >-
            The amount of time (in seconds) that can elapse before the FortiGate
            Autoscale lifecycle hook times out. Minimum is 60. Maximum is 3600.
    FgtAsgCooldown:
        Type: Number
        Default: 300
        MinValue: 60
        MaxValue: 3600
        ConstraintDescription: must be a valid number between 60 and 3600.
        Description: >-
            The Auto Scaling group waits for the cooldown period (in seconds) to
            complete before resuming scaling activities. Minimum is 60. Maximum
            is 3600.
    FgtAsgDesiredCapacityByol:
        Type: Number
        Default: 2
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            The number of FortiGate instances the BYOL Auto Scaling group should
            have at any time. For High Availability in BYOL-only and Hybrid use
            cases, ensure at least 2 FortiGates are in the group. For specific
            use cases, set to 0 for On-Demand-only, and >= 2 for BYOL-only or
            hybrid licensing.
    FgtAsgMinSizeByol:
        Type: Number
        Default: 2
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            Minimum number of FortiGate instances in the BYOL Auto Scaling
            group. For specific use cases, set to 0 for On-Demand-only, and >= 2
            for BYOL-only or hybrid licensing.
    FgtAsgMaxSizeByol:
        Type: Number
        Default: 2
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            Maximum number of FortiGate instances in the BYOL Auto Scaling
            group. For specific use cases, set to 0 for On-Demand-only, and >= 2
            for BYOL-only or hybrid licensing. This number must be greater than
            or equal to the Minimum group size (BYOL).
    FgtAsgDesiredCapacityPayg:
        Type: Number
        Default: 0
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            The number of FortiGate instances the On-Demand Auto Scaling group
            should have at any time. For High Availability in a On-Demand-only
            use case, ensure at least 2 FortiGates are in the group. For
            specific use cases, set to 0 for BYOL-only, >= 2 for On-Demand-only,
            and >= 0 for hybrid licensing.
    FgtAsgMinSizePayg:
        Type: Number
        Default: 0
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            Minimum number of FortiGate instances in the On-Demand Auto Scaling
            group. For specific use cases, set to 0 for BYOL-only, >= 2 for
            On-Demand-only, and >= 0 for hybrid licensing.
    FgtAsgMaxSizePayg:
        Type: Number
        Default: 6
        MinValue: 0
        ConstraintDescription: must be a valid number not less than 0.
        Description: >-
            Maximum number of FortiGate instances in the On-Demand Auto Scaling
            group. For specific use cases, set to 0 for BYOL-only, >= 2 for
            On-Demand-only, and >= 0 for hybrid licensing. This number must be
            greater than or equal to the Minimum group size (On-Demand).
    FgtAsgHealthCheckGracePeriod:
        Type: Number
        Default: 300
        MinValue: 60
        ConstraintDescription: must be a valid number not less than 60.
        Description: >-
            The length of time (in seconds) that Auto Scaling waits before
            checking an instance's health status. Minimum is 60.
    FgtAsgScaleInThreshold:
        Type: Number
        Default: 25
        MinValue: 1
        MaxValue: 100
        ConstraintDescription: must be a valid number between 1 and 100.
        Description: >-
            The threshold (in percentage) for the FortiGate Auto Scaling group
            to scale-in (remove) 1 instance. Minimum is 1. Maximum is 100.
    FgtAsgScaleOutThreshold:
        Type: Number
        Default: 80
        MinValue: 1
        MaxValue: 100
        ConstraintDescription: must be a valid number between 1 and 100.
        Description: >-
            The threshold (in percentage) for the FortiGate Auto Scaling group
            to scale-out (add) 1 instance. Minimum is 1. Maximum is 100.
    FortiGatePskSecret:
        Type: String
        NoEcho: true
        MaxLength: '128'
        Description: >-
            A secret key for the FortiGate instances to securely communicate
            with each other. Must contain numbers and letters and may contain
            special characters. Max length is 128.
    FortiGateAdminPort:
        Type: Number
        Default: 8443
        MinValue: 1
        MaxValue: 65535
        ConstraintDescription: must be a valid port number between 1 and 65535.
        Description: >-
            A port number for FortiGate administration. Minimum is 1. Maximum is
            65535. Do not use the FortiGate reserved ports 443, 541, 514, or
            703.
    FortiGateAdminCidr:
        Type: String
        AllowedPattern: >-
            ^(([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]){1}(\/([0-9]|[1-2][0-9]|3[0-2]))?$
        ConstraintDescription: >-
            must be a valid CIDR block format and 0.0.0.0/0 is highly not
            recommended.
        Description: >-
            CIDR block for external admin management access. **WARNING!**
            0.0.0.0/0 accepts connections from any IP address. We recommend that
            you use a constrained CIDR range to reduce the potential of inbound
            attacks from unknown IP addresses.
    KeyPairName:
        Type: 'AWS::EC2::KeyPair::KeyName'
        ConstraintDescription: must specify an admin access key pair for FortiGate instances.
        Description: Amazon EC2 Key Pair for admin access.
    PrimaryElectionTimeout:
        Type: Number
        Default: 300
        MinValue: 90
        MaxValue: 3600
        ConstraintDescription: must be a valid number between 90 and 3600.
        Description: >-
            The maximum time (in seconds) to wait for a primary election to
            complete. Minimum is 30. Maximum is 3600.
    HeartBeatInterval:
        Type: Number
        Default: 30
        MinValue: 30
        MaxValue: 90
        ConstraintDescription: must be a valid number between 30 and 90.
        Description: >-
            The length of time (in seconds) that a FortiGate instance waits
            between sending heartbeat requests to the Autoscale handler. Minimum
            is 30. Maximum is 90.
    HeartBeatLossCount:
        Type: Number
        Default: 10
        MinValue: 1
        MaxValue: 65535
        ConstraintDescription: must be a valid number between 1 and 65535.
        Description: >-
            Number of consecutively lost heartbeats. When the Heartbeat Loss
            Count has been reached, the VM is deemed unhealthy and fail-over
            activities will commence.
    HeartBeatDelayAllowance:
        Type: Number
        Default: 2
        MinValue: 0
        Description: >-
            The maximum amount of time (in seconds) allowed for network latency
            of the FortiGate heartbeat arriving at the Autoscale handler.
            Minimum is 0.
    LoadBalancingTrafficProtocol:
        Type: String
        Default: HTTPS
        AllowedValues:
            - HTTP
            - HTTPS
            - TCP
        ConstraintDescription: value must be chosen from the provided options.
        Description: Use this protocol to load balance traffic.
    LoadBalancingTrafficPort:
        Type: Number
        Default: 443
        MinValue: 1
        MaxValue: 65535
        ConstraintDescription: must be a valid port number between 1 and 65535.
        Description: >-
            Balance web service traffic over this port if the internal
            web-service load balancer is enabled. Minimum is 1. Maximum is
            65535.
    LoadBalancingHealthCheckThreshold:
        Type: Number
        Default: 3
        MinValue: 3
        ConstraintDescription: must be a valid number not less than 3.
        Description: >-
            The number of consecutive health check failures required before
            considering a FortiGate instance unhealthy. Minimum is 3.
    InternalLoadBalancingOptions:
        Type: String
        Default: do not need one
        AllowedValues:
            - add a new internal load balancer
            - use a load balancer specified below
            - do not need one
        ConstraintDescription: must choose from the provided options.
        Description: >-
            (Optional) Add a predefined Elastic Load Balancer (ELB) to route
            traffic to web service in the private subnets. You can optionally
            use your own one or decide to not need one.
    InternalTargetGroupHealthCheckPath:
        Type: String
        Default: /
        AllowedPattern: '^/[0-9a-zA-Z-/]*$'
        MaxLength: 1024
        ConstraintDescription: >-
            This path must begin with a '/' character, and can be at most 1024
            characters in length.
        Description: >-
            Optional. The destination path for health checks. This path must
            begin with a '/' character, and can be at most 1024 characters in
            length.
    InternalLoadBalancerDnsName:
        Type: String
        Default: ''
        Description: >-
            Optional. Specify the DNS Name of an existing internal load balancer
            used to route traffic from a FortiGate to targets in a specified
            target group. Leave it blank if you don't use an existing load
            balancer.
    GetLicenseGracePeriod:
        Type: Number
        Default: 600
        MinValue: 300
        ConstraintDescription: must be a valid number not less than 300.
        Description: >-
            The minimum time (in seconds) permitted before a distributed license
            can be revoked from a non-responsive FortiGate and re-distributed.
            Minimum is 300.
    TransitGatewaySupportOptions:
        Type: String
        Default: do not need one
        AllowedValues:
            - create one
            - use an existing one
            - do not need one
        ConstraintDescription: must choose from the provided options.
        Description: >-
            Create a Transit Gateway for the FortiGate Autoscale VPC to attach
            to, or specify to use an existing one.
    TransitGatewayId:
        Type: String
        Default: ''
        Description: >-
            If you use an existing Transit Gateway, specify the ID of the
            Transit Gateway that the FortiGate Autoscale VPC is attached to.
    BgpAsn:
        Type: Number
        MinValue: 64512
        Default: 65000
        MaxValue: 65534
        Description: >-
            The Border Gateway Protocol (BGP) Autonomous System Number of the
            Customer Gateway of each FortiGate instance in the Auto Scaling
            Group. This value ranges from 64512 to 65534.
    NetworkLoadBalancerIntegration:
        Type: String
        Default: 'no'
        AllowedValues:
            - 'yes'
            - 'no'
        ConstraintDescription: must choose from the provided options.
        Description: Will deploy with Network Load Balancer Integration.
    TransitGatewayIntegration:
        Type: String
        Default: 'no'
        AllowedValues:
            - 'yes'
            - 'no'
        ConstraintDescription: must choose from the provided options.
        Description: Will deploy with Transit Gateway Integration.
    UseCustomAssetLocation:
        Type: String
        Default: 'no'
        AllowedValues:
            - 'yes'
            - 'no'
        ConstraintDescription: must choose from the provided options.
        Description: Will use a custom S3 location for custom assets.
    CustomAssetContainer:
        Type: String
        Default: ''
        Description: >-
            The name of the S3 bucket which contains your custom assets.
            Required if 'use custom asset location' is set to 'yes'.
    CustomAssetDirectory:
        Type: String
        Default: ''
        Description: >-
            The sub path within the 'custom asset container' which serves as the
            top level directory of all your custom assets. If 'use custom asset
            location' is set to 'yes', and this value is left empty, the 'custom
            asset container' will serve as the top level directory.
    FortiAnalyzerIntegrationOptions:
        Type: String
        AllowedValues:
            - 'yes'
            - 'no'
        Description: >-
            Choose 'yes' to incorporate FortiAnalyzer into FortiGate Auto
            Scaling to use extended features that include storing logs into
            FortiAnalyzer.
    FortiAnalyzerInstanceType:
        Type: String
        Description: >-
            The instance type to launch as FortiAnalyzer On-Demand instances.
            There are t2.small and compute-optimized instances such as m4 and c4
            available with different vCPU sizes and bandwidths. For more
            information about instance types, see
            https://aws.amazon.com/ec2/instance-types/
    FortiAnalyzerVersion:
        Type: String
        Description: The FortiAnalyzer version supported by FortiGate Auto Scaling.
    FortiAnalyzerAutoscaleAdminUsername:
        Type: String
        AllowedPattern: '^$|^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$'
        ConstraintDescription: >-
            This FortiAnalyzer account name can include numbers, lowercase
            letters, uppercase letters, and hyphens (-). It cannot start or end
            with a hyphen (-).
        Description: >-
            The name of the secondary administrator level account in the
            FortiAnalyzer, which FortiGate Auto Scaling uses to connect to the
            FortiAnalyzer to authorize any FortiGate device in the Auto Scaling
            group. To conform to the FortiAnalyzer naming policy, the username
            can only contain numbers, lowercase letters, uppercase letters, and
            hyphens. It cannot start or end with a hyphen (-).
    FortiAnalyzerAutoscaleAdminPassword:
        Type: String
        NoEcho: true
        MinLength: 8
        MaxLength: 128
        Description: >-
            The password for the 'Autoscale admin username'. The password must
            conform to the FortiAnalyzer password policy and have a min length
            of 8 and a max length 128. If you need to enable KMS encryption,
            refer to the documentation.
    FortiAnalyzerCustomPrivateIpAddress:
        Type: String
        AllowedPattern: >-
            ^$|^(([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5]){1}$
        ConstraintDescription: must be a valid IPv4 format.
        Description: >-
            The static private IP address allocated for the FortiAnalyzer in the
            designated subnet.
    AutoscaleNotificationSubscriberEmail:
        Type: String
        AllowedPattern: '^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\.[a-zA-Z0-9-.]+$'
        ConstraintDescription: must be a valid email address.
        Description: >-
            The email address (AWS SNS Topic subscriber) to receive Autoscale
            notifications. A confirmation letter will be sent to it. Only one
            email address is allowed.
    TerminateUnhealthyVm:
        Type: String
        Default: 'no'
        AllowedValues:
            - 'yes'
            - 'no'
        ConstraintDescription: must choose from the provided options.
        Description: Terminate any VM that is deemed unhealthy by the Autoscale.
    SyncRecoveryCount:
        Type: Number
        MinValue: 3
        Default: 3
        Description: >-
            Number of consecutively on-time heartbeats for a VM to become
            healthy again. When 'Terminate Unhealthy VM' is set to 'no' and a
            VM is once deemed unhealthy, it allows for the VM to recovery from
            the unhealthy state within an amount of on-time heartbeat sync.
Rules:
    FortiAnalyzerSupport:
        RuleCondition: !Equals
            - !Ref FortiAnalyzerIntegrationOptions
            - 'yes'
        Assertions:
            - Assert: !Not
                  - !Equals
                    - !Ref FortiAnalyzerAutoscaleAdminUsername
                    - ''
              AssertDescription: >-
                  If FortiAnalyzer integration set to 'yes', the 'Autoscale
                  admin username' parameter must not be empty.
            - Assert: !Not
                  - !Equals
                    - !Ref FortiAnalyzerAutoscaleAdminPassword
                    - ''
              AssertDescription: >-
                  If FortiAnalyzer integration set to 'yes', the 'Autoscale
                  admin password' parameter must not be empty.
            - Assert: !Not
                  - !Equals
                    - !Ref FortiAnalyzerCustomPrivateIpAddress
                    - ''
              AssertDescription: >-
                  If FortiAnalyzer integration set to 'yes', the
                  'FortiAnalyzer private IP address' parameter must not be
                  empty.
Conditions:
    IfInUSGovCloud: !Or
        - !Equals
          - !Ref 'AWS::Region'
          - us-gov-east-1
        - !Equals
          - !Ref 'AWS::Region'
          - us-gov-west-1
    IfNewInternalLoadBalancer: !And
        - !Equals
          - !Ref NetworkLoadBalancerIntegration
          - 'yes'
        - !Equals
          - !Ref InternalLoadBalancingOptions
          - add a new internal load balancer
    IfUseInternalLoadBalancer: !And
        - !Equals
          - !Ref NetworkLoadBalancerIntegration
          - 'yes'
        - !Or
          - !Equals
            - !Ref InternalLoadBalancingOptions
            - add a new internal load balancer
          - !Equals
            - !Ref InternalLoadBalancingOptions
            - use a load balancer specified below
    IfPAYGOnly: !And
        - !Equals
          - !Ref FgtAsgDesiredCapacityByol
          - 0
        - !Equals
          - !Ref FgtAsgMaxSizeByol
          - 0
    IfBYOLOnly: !And
        - !Not
          - !Equals
            - !Ref FgtAsgMinSizeByol
            - 0
        - !Not
          - !Equals
            - !Ref FgtAsgMaxSizeByol
            - 0
        - !Equals
          - !Ref FgtAsgMinSizePayg
          - 0
        - !Equals
          - !Ref FgtAsgMaxSizePayg
          - 0
    IfCreateTransitGateway: !And
        - !Equals
          - !Ref TransitGatewayIntegration
          - 'yes'
        - !Equals
          - !Ref TransitGatewaySupportOptions
          - create one
    IfRequireSecondNic: !Equals
        - !Ref NetworkLoadBalancerIntegration
        - 'yes'
    IfRequireTransitGatewayIntegration: !Equals
        - !Ref TransitGatewayIntegration
        - 'yes'
    IfRequireNetworkLoadBalancerIntegration: !Equals
        - !Ref NetworkLoadBalancerIntegration
        - 'yes'
    IfRequireFortiAnalyzerIntegration: !Equals
        - !Ref FortiAnalyzerIntegrationOptions
        - 'yes'
    IfUseCustomAssetContainer: !Equals
        - !Ref UseCustomAssetLocation
        - 'yes'
    IfIntegrateFortiAnalyzer: !Equals
        - !Ref FortiAnalyzerIntegrationOptions
        - 'yes'
    IfCreateVPCEndpoint: !Equals
        - !Ref VpcEndpointId
        - ''
    IfTerminateUnhealthyVm: !Equals
        - !Ref TerminateUnhealthyVm
        - 'yes'
Mappings:
    ProductVersionMap:
        FortiGateByol:
            '625': FGTVM64BYOL625
            '646': FGTVM64BYOL646
            '700': FGTVM64BYOL700
            '701': FGTVM64BYOL701
        FortiGatePayg:
            '625': FGTVM64PAYG625
            '646': FGTVM64PAYG646
            '700': FGTVM64PAYG700
            '701': FGTVM64PAYG701
        FortiAnalyzerPayg:
            '646': FAZVM64PAYG646
    AWSAMIRegionMap:
        AMI:
            FGTVM64BYOL700: >-
                aws-marketplace/FortiGate-VM64-AWS build0066 (7.0.0)
                GA-e5936f4a-0d69-479f-919c-d5e158bd4d12
            FGTVM64BYOL646: >-
                aws-marketplace/FortiGate-VM64-AWS build1879 (6.4.6)
                GA-e5936f4a-0d69-479f-919c-d5e158bd4d12
            FGTVM64BYOL625: >-
                aws-marketplace/FortiGate-VM64-AWS build1142 (6.2.5)
                GA-e5936f4a-0d69-479f-919c-d5e158bd4d12-ami-00bbcf1a9e105fdd9.4
            FGTVM64PAYG700: >-
                aws-marketplace/FortiGate-VM64-AWSONDEMAND build0066 (7.0.0)
                GA-3124a694-441c-4ff1-8bf7-4d153be424a6
            FGTVM64PAYG646: >-
                aws-marketplace/FortiGate-VM64-AWSONDEMAND build1879 (6.4.6)
                GA-3124a694-441c-4ff1-8bf7-4d153be424a6
            FGTVM64PAYG625: >-
                aws-marketplace/FortiGate-VM64-AWSONDEMAND build1142 (6.2.5)
                GA-3124a694-441c-4ff1-8bf7-4d153be424a6-ami-039c7057c0cb2f28c.4
            FAZVM64PAYG646: >-
                aws-marketplace/FortiAnalyzer VM64-AWSOnDemand build2363 (6.4.6)
                GA-5bc06b01-2e8b-4205-b84c-8ac24e5925cb
            FGTVM64BYOL701: >-
                aws-marketplace/FortiGate-VM64-AWS build0157 (7.0.1)
                GA-e5936f4a-0d69-479f-919c-d5e158bd4d12
            FGTVM64PAYG701: >-
                aws-marketplace/FortiGate-VM64-AWSONDEMAND build0157 (7.0.1)
                GA-3124a694-441c-4ff1-8bf7-4d153be424a6
        ap-east-1:
            FGTVM64BYOL700: ami-04c86a4d790dfc955
            FGTVM64BYOL646: ami-0c494d02920054924
            FGTVM64BYOL625: ami-0bc80777e8ecd2fd4
            FGTVM64PAYG700: ami-02148e751d8ce6c1d
            FGTVM64PAYG646: ami-0a001d08d7b5d18a0
            FGTVM64PAYG625: ami-0f87879707d7eb53b
            FAZVM64PAYG646: ami-0b3f2ebec825fe9b2
            FGTVM64BYOL701: ami-069022a0b0042e2b8
            FGTVM64PAYG701: ami-0ba7332b78dedfdf0
        ap-northeast-1:
            FGTVM64BYOL700: ami-0656212a93166e13f
            FGTVM64BYOL646: ami-0ac940c7a68e05199
            FGTVM64BYOL625: ami-03a44d551d2655520
            FGTVM64PAYG700: ami-0c549c1d962b7cc28
            FGTVM64PAYG646: ami-0b81ee38d9205761f
            FGTVM64PAYG625: ami-0719f5a76c460f5d5
            FAZVM64PAYG646: ami-0372eced64d39b113
            FGTVM64BYOL701: ami-0bfb0a297a846758d
            FGTVM64PAYG701: ami-0e45541bf4f626eb8
        ap-northeast-2:
            FGTVM64BYOL700: ami-00eda4a12b5e6abf3
            FGTVM64BYOL646: ami-080aac17979acbe8a
            FGTVM64BYOL625: ami-0b23bc07c2fa3e877
            FGTVM64PAYG700: ami-040206dd95f5dae4d
            FGTVM64PAYG646: ami-0f69a72652e376805
            FGTVM64PAYG625: ami-0a6031ab5eab79c20
            FAZVM64PAYG646: ami-026b4cfa5d22a63a4
            FGTVM64BYOL701: ami-0a0e4c41637e6936f
            FGTVM64PAYG701: ami-0d90068740a70e960
        ap-south-1:
            FGTVM64BYOL700: ami-005f774c3443d956e
            FGTVM64BYOL646: ami-0e74793df70561ae0
            FGTVM64BYOL625: ami-0b68a611afe49fc71
            FGTVM64PAYG700: ami-07def664c3a7d57b8
            FGTVM64PAYG646: ami-0a40a56775ad40c3c
            FGTVM64PAYG625: ami-0fef6a98991903a53
            FAZVM64PAYG646: ami-090e429c16342495e
            FGTVM64BYOL701: ami-00609a13c17b3cf5d
            FGTVM64PAYG701: ami-0f8da603aeae144f0
        ap-southeast-1:
            FGTVM64BYOL700: ami-0bc23aee33e9c0b6c
            FGTVM64BYOL646: ami-069f5672f4dd9dc3e
            FGTVM64BYOL625: ami-0549e633fb851ac8d
            FGTVM64PAYG700: ami-0bec3fa7b49492202
            FGTVM64PAYG646: ami-039794888c9b1e500
            FGTVM64PAYG625: ami-05828bd3f0a3db641
            FAZVM64PAYG646: ami-0629876ac75c8be66
            FGTVM64BYOL701: ami-0d9a129903b7ba964
            FGTVM64PAYG701: ami-0aa8b7bcf2a04ad1f
        ap-southeast-2:
            FGTVM64BYOL700: ami-0241253d4175098df
            FGTVM64BYOL646: ami-0edb09abd4de17b20
            FGTVM64BYOL625: ami-0e0aaee103a2bcbdb
            FGTVM64PAYG700: ami-0a7013c7c28f2c667
            FGTVM64PAYG646: ami-091b98549e5675bbe
            FGTVM64PAYG625: ami-0f4fab7f013056f76
            FAZVM64PAYG646: ami-01761ede87089faf1
            FGTVM64BYOL701: ami-0b9ef7623fc628069
            FGTVM64PAYG701: ami-0793fa38bb58f353e
        ca-central-1:
            FGTVM64BYOL700: ami-00f4cf5a2ec67f01a
            FGTVM64BYOL646: ami-0d8e2e78e928def11
            FGTVM64BYOL625: ami-004648d19cfd860e7
            FGTVM64PAYG700: ami-02d3b40ce0f2be79e
            FGTVM64PAYG646: ami-08ac0958fe75153e2
            FGTVM64PAYG625: ami-0d612c780a379a0fa
            FAZVM64PAYG646: ami-0196e5f5f42d24113
            FGTVM64BYOL701: ami-0f5966c7ff86c1cb6
            FGTVM64PAYG701: ami-0e92233e968a00d5a
        eu-central-1:
            FGTVM64BYOL700: ami-0fbc69c41159026cd
            FGTVM64BYOL646: ami-0529297f63bef8b4d
            FGTVM64BYOL625: ami-027d165eaf560c9eb
            FGTVM64PAYG700: ami-07a164a40b3fab627
            FGTVM64PAYG646: ami-0781f07684853501c
            FGTVM64PAYG625: ami-074ed751bba670031
            FAZVM64PAYG646: ami-027e27b0fbf34a4af
            FGTVM64BYOL701: ami-09ca8648996694d40
            FGTVM64PAYG701: ami-0c48bc0e23f9042fc
        eu-north-1:
            FGTVM64BYOL700: ami-0cfc06894012624ab
            FGTVM64BYOL646: ami-0d565793fcafcc38d
            FGTVM64BYOL625: ami-081a7b2f8ad208918
            FGTVM64PAYG700: ami-091492883a1e4e2b6
            FGTVM64PAYG646: ami-026922081bf660a55
            FGTVM64PAYG625: ami-018fddc5a66efd4f7
            FAZVM64PAYG646: ami-0dd417b29b9491506
            FGTVM64BYOL701: ami-0907f64a7bbfb94ff
            FGTVM64PAYG701: ami-0f21240140d3d2866
        eu-west-1:
            FGTVM64BYOL700: ami-05cd458dd16b40fc8
            FGTVM64BYOL646: ami-05d1628fbb3c4578a
            FGTVM64BYOL625: ami-06e464877bd092274
            FGTVM64PAYG700: ami-0fcd573f69714ed57
            FGTVM64PAYG646: ami-0313241e3849e200d
            FGTVM64PAYG625: ami-02c09d8eb6fd583f9
            FAZVM64PAYG646: ami-0b13842c5eb85ae11
            FGTVM64BYOL701: ami-01118ca5692326739
            FGTVM64PAYG701: ami-066f47e167e4090e0
        eu-west-2:
            FGTVM64BYOL700: ami-06d26c9c2b173184d
            FGTVM64BYOL646: ami-0317f3b2e62373002
            FGTVM64BYOL625: ami-0ed6d602c754a9c40
            FGTVM64PAYG700: ami-0deb30f490c8dd07f
            FGTVM64PAYG646: ami-094ac06a8c76d4ab9
            FGTVM64PAYG625: ami-05c9d427d1f35d743
            FAZVM64PAYG646: ami-00029a49066218b92
            FGTVM64BYOL701: ami-073e5153688b42f25
            FGTVM64PAYG701: ami-073e93d6afc52ee0e
        eu-west-3:
            FGTVM64BYOL700: ami-0d25245082df1074a
            FGTVM64BYOL646: ami-00a280c8a4261248d
            FGTVM64BYOL625: ami-084ea96a1e1c65c58
            FGTVM64PAYG700: ami-0d16a8df07a13375d
            FGTVM64PAYG646: ami-02e98b116ca7b3e07
            FGTVM64PAYG625: ami-070a87ca27e3f49a8
            FAZVM64PAYG646: ami-0bcb9fea61d390d17
            FGTVM64BYOL701: ami-00e8ba0a04789ad0e
            FGTVM64PAYG701: ami-07a5212e5d2fee5ed
        me-south-1:
            FGTVM64BYOL700: ami-051f14f36368e32ed
            FGTVM64BYOL646: ami-06d5df3d3fa7ee303
            FGTVM64BYOL625: ami-00e1681caf8c9fa9e
            FGTVM64PAYG700: ami-04a68927aa0cc21ab
            FGTVM64PAYG646: ami-086944e0448c9dbed
            FGTVM64PAYG625: ami-00adf30362358258c
            FAZVM64PAYG646: ami-0971ecc780edeeee2
            FGTVM64BYOL701: ami-098b025df177bd3d4
            FGTVM64PAYG701: ami-0694965772c0df593
        sa-east-1:
            FGTVM64BYOL700: ami-089b5807bf62919a0
            FGTVM64BYOL646: ami-0bb84b0b8fe08f99e
            FGTVM64BYOL625: ami-0bf329b3e3b77a5f7
            FGTVM64PAYG700: ami-01ab2ddf70adbae51
            FGTVM64PAYG646: ami-0d4a43052db2cfb3d
            FGTVM64PAYG625: ami-0a9f0f421cf4664d9
            FAZVM64PAYG646: ami-08ab49f8a1f5083f2
            FGTVM64BYOL701: ami-01abe8a3a6cd165e7
            FGTVM64PAYG701: ami-0c80c01c54651d66e
        us-east-1:
            FGTVM64BYOL700: ami-0eb86d725cdceaebc
            FGTVM64BYOL646: ami-076ce1e827764065b
            FGTVM64BYOL625: ami-0c006e740dba8ed86
            FGTVM64PAYG700: ami-01a54d044634cf0f6
            FGTVM64PAYG646: ami-02dfec160890bf070
            FGTVM64PAYG625: ami-0622e983a045449fb
            FAZVM64PAYG646: ami-0fc8788974f1efa85
            FGTVM64BYOL701: ami-02678839ab63d47a1
            FGTVM64PAYG701: ami-0b9c648555f605b8a
        us-east-2:
            FGTVM64BYOL700: ami-04e4d720d31e93509
            FGTVM64BYOL646: ami-0d10c9cc98e5d13ec
            FGTVM64BYOL625: ami-091a2d656744ed01a
            FGTVM64PAYG700: ami-03ab0acba901bbec4
            FGTVM64PAYG646: ami-045bf7672b62be89c
            FGTVM64PAYG625: ami-0028f84cdc301b03f
            FAZVM64PAYG646: ami-05ab479c695965c84
            FGTVM64BYOL701: ami-01fc50db5a27388fa
            FGTVM64PAYG701: ami-048fa209a6f531c8e
        us-gov-east-1:
            FGTVM64BYOL700: ami-0b579865374e02ae6
            FGTVM64BYOL646: ami-0c9b80759709cb0b4
            FGTVM64PAYG700: ami-09c31384c7aa766fb
            FGTVM64PAYG646: ami-001a9f6807dff262b
            FAZVM64PAYG646: ami-0809af14dc49bf1f3
            FGTVM64BYOL701: ami-07758bd040b41a1bf
            FGTVM64PAYG701: ami-0f066ebd85ecb54b9
        us-gov-west-1:
            FGTVM64BYOL700: ami-0f6793ab47cba7d27
            FGTVM64BYOL646: ami-07661745569bc241b
            FGTVM64PAYG700: ami-062c78ed9dde39db4
            FGTVM64PAYG646: ami-001a9f6807dff262b
            FAZVM64PAYG646: ami-08922ac3ad1de0e53
            FGTVM64BYOL701: ami-0b6f61bf4e4420bf6
            FGTVM64PAYG701: ami-017ebf872f09c30d4
        us-west-1:
            FGTVM64BYOL700: ami-01c16bdc91332f7ab
            FGTVM64BYOL646: ami-0d0ee5453bacacdc3
            FGTVM64BYOL625: ami-0882a73188ba2e149
            FGTVM64PAYG700: ami-0d47e4065bc75afd0
            FGTVM64PAYG646: ami-088426c38c82189c4
            FGTVM64PAYG625: ami-00be71abeaee9792a
            FAZVM64PAYG646: ami-0e99754cbbad84a96
            FGTVM64BYOL701: ami-09e5387cc293153c1
            FGTVM64PAYG701: ami-0bed74e557899b316
        us-west-2:
            FGTVM64BYOL700: ami-06001decb1cc65300
            FGTVM64BYOL646: ami-0a79ef31f760b0a6d
            FGTVM64BYOL625: ami-0dd91f0e4b4c0c749
            FGTVM64PAYG700: ami-0bcde5f20befaef29
            FGTVM64PAYG646: ami-0aeebdd62d4b9393e
            FGTVM64PAYG625: ami-05cfe4f5761707079
            FAZVM64PAYG646: ami-0b8b854d1521adc10
            FGTVM64BYOL701: ami-0070ab4edc735c379
            FGTVM64PAYG701: ami-0450a759578d5f9e8
    ProtocolPortMap:
        HTTP:
            defaultport: '80'
        HTTPS:
            defaultport: '443'
        TCP:
            defaultport: '443'
Resources:
    StackCreateDynamoDBTable:
        Type: 'AWS::CloudFormation::Stack'
        Properties:
            Parameters:
                ResourceTagPrefix: !Ref ResourceTagPrefix
                EnableSecondNic: !If
                    - IfRequireSecondNic
                    - 'yes'
                    - 'no'
                EnableVmInfoCache: 'no'
                EnableCustomLog: 'yes'
                EnableTransitGatewayVpn: !If
                    - IfRequireTransitGatewayIntegration
                    - 'yes'
                    - 'no'
                EnableHybridLicensing: 'yes'
                EnableFortiAnalyzer: !If
                    - IfRequireFortiAnalyzerIntegration
                    - 'yes'
                    - 'no'
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-db-table.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    FgtInstanceIamRole:
        Type: 'AWS::IAM::Role'
        Properties:
            ManagedPolicyArns:
                - !Sub
                  - >-
                      arn:aws${GovCloudSuffix}:iam::aws:policy/AmazonS3ReadOnlyAccess
                  - GovCloudSuffix: !If
                        - IfInUSGovCloud
                        - '-us-gov'
                        - ''
                - !Sub
                  - >-
                      arn:aws${GovCloudSuffix}:iam::aws:policy/AWSLambdaExecute
                  - GovCloudSuffix: !If
                        - IfInUSGovCloud
                        - '-us-gov'
                        - ''
            AssumeRolePolicyDocument:
                Version: 2012-10-17
                Statement:
                    - Effect: Allow
                      Principal:
                          Service: ec2.amazonaws.com
                      Action: 'sts:AssumeRole'
            Path: /
            Policies:
                - PolicyDocument:
                      Version: 2012-10-17
                      Statement:
                          - Action:
                                - 's3:ListBucket'
                            Resource:
                                - !If
                                  - IfUseCustomAssetContainer
                                  - !Sub
                                    - >-
                                        arn:aws${GovCloudSuffix}:s3:::${CustomContainer}
                                    - GovCloudSuffix: !If
                                          - IfInUSGovCloud
                                          - '-us-gov'
                                          - ''
                                      CustomContainer: !Ref CustomAssetContainer
                                  - !Sub
                                    - >-
                                        arn:aws${GovCloudSuffix}:s3:::${S3BucketName}
                                    - GovCloudSuffix: !If
                                          - IfInUSGovCloud
                                          - '-us-gov'
                                          - ''
                                      S3BucketName: !Ref S3BucketName
                            Effect: Allow
                          - Action:
                                - 's3:GetObject'
                            Resource: !If
                                - IfUseCustomAssetContainer
                                - - !Sub
                                    - >-
                                        arn:aws${GovCloudSuffix}:s3:::${S3BucketName}/${S3KeyPrefix}assets/*
                                    - GovCloudSuffix: !If
                                          - IfInUSGovCloud
                                          - '-us-gov'
                                          - ''
                                      S3BucketName: !Ref S3BucketName
                                      S3KeyPrefix: !Ref S3KeyPrefix
                                  - !Sub
                                    - >-
                                        arn:aws${GovCloudSuffix}:s3:::${CustomContainer}/${CustomDirectory}*
                                    - GovCloudSuffix: !If
                                          - IfInUSGovCloud
                                          - '-us-gov'
                                          - ''
                                      CustomContainer: !Ref CustomAssetContainer
                                      CustomDirectory: !Ref CustomAssetDirectory
                                - - !Sub
                                    - >-
                                        arn:aws${GovCloudSuffix}:s3:::${S3BucketName}/${S3KeyPrefix}assets/*
                                    - GovCloudSuffix: !If
                                          - IfInUSGovCloud
                                          - '-us-gov'
                                          - ''
                                      S3BucketName: !Ref S3BucketName
                                      S3KeyPrefix: !Ref S3KeyPrefix
                            Effect: Allow
                  PolicyName: fortigate-autoscale-instance-policy
    FgtInstanceProfile:
        Type: 'AWS::IAM::InstanceProfile'
        Properties:
            Roles:
                - !Ref FgtInstanceIamRole
    FgtAsgSecurityGroup:
        Type: 'AWS::EC2::SecurityGroup'
        Properties:
            GroupDescription: FortiGate security group
            VpcId: !Ref VpcId
            Tags:
                - Key: Name
                  Value: !Join
                      - '-'
                      - - !Ref ResourceTagPrefix
                        - fortigate-autoscale-security-group
                - Key: ResourceGroup
                  Value: !Ref ResourceTagPrefix
    FgtAsgSecurityGroupIngressInternal:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: '-1'
            CidrIp: !Ref VpcCidr
    FgtAsgSecurityGroupIngressSSH:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: tcp
            FromPort: '22'
            ToPort: '22'
            CidrIp: !Ref FortiGateAdminCidr
    FgtAsgSecurityGroupIngressSecFabMgmt1:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: tcp
            FromPort: '541'
            ToPort: '541'
            CidrIp: !Ref VpcCidr
    FgtAsgSecurityGroupIngressSecFabMgmt2:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: tcp
            FromPort: '514'
            ToPort: '514'
            CidrIp: !Ref VpcCidr
    FgtAsgSecurityGroupIngressSecFabMgmt3:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: udp
            FromPort: '514'
            ToPort: '514'
            CidrIp: !Ref VpcCidr
    FgtAsgSecurityGroupIngressAdminAccess:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: tcp
            FromPort: !Ref FortiGateAdminPort
            ToPort: !Ref FortiGateAdminPort
            CidrIp: !Ref FortiGateAdminCidr
    FgtAsgSecurityGroupIngressTraffic:
        Type: 'AWS::EC2::SecurityGroupIngress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: tcp
            FromPort: !Ref LoadBalancingTrafficPort
            ToPort: !Ref LoadBalancingTrafficPort
            CidrIp: 0.0.0.0/0
    FgtAsgSecurityGroupEgressInternal:
        Type: 'AWS::EC2::SecurityGroupEgress'
        Properties:
            GroupId: !Ref FgtAsgSecurityGroup
            IpProtocol: '-1'
            CidrIp: 0.0.0.0/0
    FgtAsgVpcEndpoint:
        Type: 'AWS::EC2::VPCEndpoint'
        Condition: IfCreateVPCEndpoint
        Properties:
            VpcEndpointType: Interface
            VpcId: !Ref VpcId
            SubnetIds:
                - !Ref PublicSubnet1
                - !Ref PublicSubnet2
            PrivateDnsEnabled: true
            ServiceName: !Sub
                - 'com.amazonaws.${region}.execute-api'
                - region: !Ref 'AWS::Region'
            SecurityGroupIds:
                - !Ref FgtAsgSecurityGroup
    StackCreateAutoScaleHandler:
        Type: 'AWS::CloudFormation::Stack'
        Properties:
            Parameters:
                S3BucketName: !Ref S3BucketName
                S3KeyPrefix: !Ref S3KeyPrefix
                ResourceTagPrefix: !Ref ResourceTagPrefix
                CustomIdentifier: !Ref CustomIdentifier
                UniqueId: !Ref UniqueId
                VpcEndPoint: !If
                    - IfCreateVPCEndpoint
                    - !Ref FgtAsgVpcEndpoint
                    - !Ref VpcEndpointId
                HandlerScriptTimeout: 300
                ServiceScriptTimeout: 900
                CreateByolLicenseHandler: 'yes'
                TransitGatewayIntegration: !If
                    - IfRequireTransitGatewayIntegration
                    - 'yes'
                    - 'no'
                CustomAssetContainer: !If
                    - IfUseCustomAssetContainer
                    - !Ref CustomAssetContainer
                    - !Ref 'AWS::NoValue'
                CustomAssetDirectory: !If
                    - IfUseCustomAssetContainer
                    - !Ref CustomAssetDirectory
                    - !Ref 'AWS::NoValue'
                RoutePermissionRouteTableId: !Ref PrivateSubnetRouteTable
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-autoscale-handler.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StackCreateTransitGatewayVpnHandler:
        Type: 'AWS::CloudFormation::Stack'
        Condition: IfRequireTransitGatewayIntegration
        Properties:
            Parameters:
                S3BucketName: !Ref S3BucketName
                S3KeyPrefix: !Ref S3KeyPrefix
                ResourceTagPrefix: !Ref ResourceTagPrefix
                CustomIdentifier: !Ref CustomIdentifier
                UniqueId: !Ref UniqueId
                CustomAssetContainer: !If
                    - IfUseCustomAssetContainer
                    - !Ref CustomAssetContainer
                    - !Ref 'AWS::NoValue'
                CustomAssetDirectory: !If
                    - IfUseCustomAssetContainer
                    - !Ref CustomAssetDirectory
                    - !Ref 'AWS::NoValue'
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-tgw-vpn-handler.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StackCreateLoadBalancingComponents:
        Type: 'AWS::CloudFormation::Stack'
        Condition: IfRequireNetworkLoadBalancerIntegration
        Properties:
            Parameters:
                ResourceTagPrefix: !Ref ResourceTagPrefix
                CustomIdentifier: !Ref CustomIdentifier
                UniqueId: !Ref UniqueId
                TrafficProtocol: !Ref LoadBalancingTrafficProtocol
                TrafficPort: !Ref LoadBalancingTrafficPort
                HealthCheckPort: !Ref FortiGateAdminPort
                FgtTargetGroupHealthCheckThreshold: !Ref LoadBalancingHealthCheckThreshold
                VpcId: !Ref VpcId
                FgtSubnetIds: !Join
                    - ','
                    - - !Ref PublicSubnet1
                      - !Ref PublicSubnet2
                NewInternalLoadBalancer: !If
                    - IfNewInternalLoadBalancer
                    - 'yes'
                    - 'no'
                InternalTargetGroupHealthCheckPath: !Ref InternalTargetGroupHealthCheckPath
                InternalLoadBalancingSubnetIds: !Join
                    - ','
                    - - !Ref PrivateSubnet1
                      - !Ref PrivateSubnet2
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-load-balancer.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StackCreateTransitGatewayComponents:
        Type: 'AWS::CloudFormation::Stack'
        Condition: IfRequireTransitGatewayIntegration
        Properties:
            Parameters:
                ResourceTagPrefix: !Ref ResourceTagPrefix
                CustomIdentifier: !Ref CustomIdentifier
                UniqueId: !Ref UniqueId
                CreateNewTransitGateway: !If
                    - IfCreateTransitGateway
                    - 'yes'
                    - 'no'
                TransitGatewayId: !Ref TransitGatewayId
                VpcId: !Ref VpcId
                PublicSubnet1: !Ref PublicSubnet1
                PublicSubnet2: !Ref PublicSubnet2
                AutoscaleHandlerIamRoleName: !GetAtt
                    - StackCreateAutoScaleHandler
                    - Outputs.FgtAsgHandlerIamRoleName
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-transit-gateway-components.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StackCreateFortiGateAutoScalingGroup:
        Type: 'AWS::CloudFormation::Stack'
        Properties:
            Parameters:
                S3BucketName: !Ref S3BucketName
                S3KeyPrefix: !Ref S3KeyPrefix
                ResourceTagPrefix: !Ref ResourceTagPrefix
                UniqueId: !Ref UniqueId
                AsgSubnet1Id: !Ref PublicSubnet1
                AsgSubnet2Id: !Ref PublicSubnet2
                ELBV2TargetGroupARNs: ''
                InstanceType: !Ref FortiGateInstanceType
                InstanceProfileArn: !GetAtt
                    - FgtInstanceProfile
                    - Arn
                KeyPairName: !Ref KeyPairName
                SecurityGroupId: !Ref FgtAsgSecurityGroup
                AsgHandlerFunctionName: !GetAtt
                    - StackCreateAutoScaleHandler
                    - Outputs.FgtAsgAutoscalingEventHandlerName
                AsgHandlerFunctionArn: !GetAtt
                    - StackCreateAutoScaleHandler
                    - Outputs.FgtAsgAutoscalingEventHandlerArn
                AsgHealthCheckGracePeriod: !Ref FgtAsgHealthCheckGracePeriod
                AsgScaleInThreshold: !Ref FgtAsgScaleInThreshold
                AsgScaleOutThreshold: !Ref FgtAsgScaleOutThreshold
                AsgDesiredCapacityByol: '0'
                AsgMinSizeByol: '0'
                AsgMaxSizeByol: !Ref FgtAsgMaxSizeByol
                AsgDesiredCapacityPayg: '0'
                AsgMinSizePayg: '0'
                AsgMaxSizePayg: !Ref FgtAsgMaxSizePayg
                AsgCooldown: !Ref FgtAsgCooldown
                LifecycleHookTimeout: !Ref LifecycleHookTimeout
                ProductAMIByol: !FindInMap
                    - AWSAMIRegionMap
                    - !Ref 'AWS::Region'
                    - !FindInMap
                      - ProductVersionMap
                      - FortiGateByol
                      - !Ref FortiOSVersion
                ProductCodeByol: ''
                ProductAMIPayg: !FindInMap
                    - AWSAMIRegionMap
                    - !Ref 'AWS::Region'
                    - !FindInMap
                      - ProductVersionMap
                      - FortiGatePayg
                      - !Ref FortiOSVersion
                ProductCodePayg: ''
                LicensingModel: !If
                    - IfPAYGOnly
                    - PAYG-Only
                    - !If
                      - IfBYOLOnly
                      - BYOL-Only
                      - Hybrid
                AutoscaleHandlerUrl: !Sub
                    - >-
                        https://${api}.execute-api.${region}.amazonaws.com/${stage}/${resource}
                    - region: !Ref 'AWS::Region'
                      api: !GetAtt
                          - StackCreateAutoScaleHandler
                          - Outputs.ApiGatewayId
                      stage: prod
                      resource: fgt-as-handler
                LicenseHandlerUrl: !Sub
                    - >-
                        https://${api}.execute-api.${region}.amazonaws.com/${stage}/${resource}
                    - region: !Ref 'AWS::Region'
                      api: !GetAtt
                          - StackCreateAutoScaleHandler
                          - Outputs.ApiGatewayId
                      stage: prod
                      resource: byol-license
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-hybrid-auto-scaling-group.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StackCreateFortiAnalyzerComponent:
        Type: 'AWS::CloudFormation::Stack'
        Condition: IfIntegrateFortiAnalyzer
        Properties:
            Parameters:
                S3BucketName: !Ref S3BucketName
                S3KeyPrefix: !Ref S3KeyPrefix
                ResourceTagPrefix: !Ref ResourceTagPrefix
                CustomIdentifier: !Ref CustomIdentifier
                UniqueId: !Select
                    - 0
                    - !Split
                      - '-'
                      - !Select
                        - 2
                        - !Split
                          - /
                          - !Ref 'AWS::StackId'
                DdbTableArnList: !GetAtt
                    - StackCreateDynamoDBTable
                    - Outputs.TableArnList
                VpcId: !Ref VpcId
                VpcCidr: !Ref VpcCidr
                SubnetId: !Ref PublicSubnet1
                InstanceType: !Ref FortiAnalyzerInstanceType
                AdminCidr: !Ref FortiGateAdminCidr
                KeyPairName: !Ref KeyPairName
                AutoscaleAdminUsername: !If
                    - IfIntegrateFortiAnalyzer
                    - !Ref FortiAnalyzerAutoscaleAdminUsername
                    - ''
                AutoscaleAdminPassword: !If
                    - IfIntegrateFortiAnalyzer
                    - !Ref FortiAnalyzerAutoscaleAdminPassword
                    - ''
                ProductAMI: !FindInMap
                    - AWSAMIRegionMap
                    - !Ref 'AWS::Region'
                    - !FindInMap
                      - ProductVersionMap
                      - FortiAnalyzerPayg
                      - !Ref FortiAnalyzerVersion
                CustomPrivateIpAddress: !If
                    - IfIntegrateFortiAnalyzer
                    - !Ref FortiAnalyzerCustomPrivateIpAddress
                    - ''
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/create-fortianalyzer-components.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 20
    SaveSettings:
        Type: 'AWS::CloudFormation::CustomResource'
        Properties:
            ServiceToken: !GetAtt
                - StackCreateAutoScaleHandler
                - Outputs.FgtAsgHandlerServiceArn
            ServiceType: saveSettings
            CustomIdentifier: !Ref CustomIdentifier
            UniqueId: !Ref UniqueId
            additional-configset-name-list: ''
            asset-storage-name: !Ref S3BucketName
            asset-storage-key-prefix: !Join
                - ''
                - - !Ref S3KeyPrefix
                  - assets/
            autoscale-function-max-execution-time: 1800
            autoscale-function-extend-execution: true
            autoscale-handler-url: !GetAtt
                - StackCreateAutoScaleHandler
                - Outputs.AutoscaleHandlerUrl
            byol-scaling-group-name: !GetAtt
                - StackCreateFortiGateAutoScalingGroup
                - Outputs.AutoScalingGroupNameByol
            byol-scaling-group-desired-capacity: !Ref FgtAsgDesiredCapacityByol
            byol-scaling-group-min-size: !Ref FgtAsgMinSizeByol
            byol-scaling-group-max-size: !Ref FgtAsgMaxSizeByol
            custom-asset-container: !If
                - IfUseCustomAssetContainer
                - !Ref CustomAssetContainer
                - n/a
            custom-asset-directory: !If
                - IfUseCustomAssetContainer
                - !Ref CustomAssetDirectory
                - n/a
            enable-external-elb: !If
                - IfRequireNetworkLoadBalancerIntegration
                - 'true'
                - 'false'
            egress-traffic-route-table: !Join
                - ','
                - - !Ref PrivateSubnetRouteTable
            enable-fortianalyzer-integration: !If
                - IfIntegrateFortiAnalyzer
                - 'true'
                - 'false'
            enable-hybrid-licensing: 'true'
            enable-internal-elb: !If
                - IfUseInternalLoadBalancer
                - 'true'
                - 'false'
            enable-second-nic: !If
                - IfRequireSecondNic
                - 'true'
                - 'false'
            enable-transit-gateway-vpn: !If
                - IfRequireTransitGatewayIntegration
                - 'true'
                - 'false'
            enable-vm-info-cache: n/a
            faz-handler-name: !If
                - IfIntegrateFortiAnalyzer
                - !GetAtt
                  - StackCreateFortiAnalyzerComponent
                  - Outputs.FazHandlerFunctionName
                - n/a
            faz-ip: !If
                - IfIntegrateFortiAnalyzer
                - !GetAtt
                  - StackCreateFortiAnalyzerComponent
                  - Outputs.FazPrivateIp
                - n/a
            fortigate-autoscale-subnet-id-list: !Join
                - ','
                - - !Ref PublicSubnet1
                  - !Ref PublicSubnet2
            fortigate-autoscale-subnet-pairs: !Sub
                - '[${SubnetPairList}]'
                - SubnetPairList: !Join
                      - ','
                      - - !Sub
                          - '{"${SubnetId}":["${PairId1}"]}'
                          - SubnetId: !Ref PublicSubnet1
                            PairId1: !Ref PrivateSubnet1
                        - !Sub
                          - '{"${SubnetId}":["${PairId1}"]}'
                          - SubnetId: !Ref PublicSubnet2
                            PairId1: !Ref PrivateSubnet2
            fortigate-autoscale-virtual-network-cidr: !Ref VpcCidr
            fortigate-admin-port: !Ref FortiGateAdminPort
            fortigate-autoscale-target-group-arn: !If
                - IfRequireNetworkLoadBalancerIntegration
                - !GetAtt
                  - StackCreateLoadBalancingComponents
                  - Outputs.FgtTargetGroupArn
                - ''
            fortigate-autoscale-virtual-network-id: !Ref VpcId
            fortigate-external-elb-dns: !If
                - IfRequireNetworkLoadBalancerIntegration
                - !GetAtt
                  - StackCreateLoadBalancingComponents
                  - Outputs.FgtLoadBalancerDnsName
                - n/a
            fortigate-internal-elb-dns: !If
                - IfUseInternalLoadBalancer
                - !If
                  - IfNewInternalLoadBalancer
                  - !GetAtt
                    - StackCreateLoadBalancingComponents
                    - Outputs.InternalLoadBalancerDnsName
                  - !Ref InternalLoadBalancerDnsName
                - n/a
            fortigate-psk-secret: !Ref FortiGatePskSecret
            fortigate-sync-interface: port1
            fortigate-traffic-port: !If
                - IfRequireNetworkLoadBalancerIntegration
                - !Ref LoadBalancingTrafficPort
                - n/a
            fortigate-traffic-protocol: !If
                - IfRequireNetworkLoadBalancerIntegration
                - !Ref LoadBalancingTrafficProtocol
                - n/a
            heartbeat-delay-allowance: !Ref HeartBeatDelayAllowance
            heartbeat-interval: !Ref HeartBeatInterval
            heartbeat-loss-count: !Ref HeartBeatLossCount
            license-file-directory: license-files
            lifecycle-hook-timeout: !Ref LifecycleHookTimeout
            primary-election-timeout: !Ref PrimaryElectionTimeout
            PrimaryElectionNoWait: 'true'
            primary-scaling-group-name: !If
                - IfPAYGOnly
                - !GetAtt
                  - StackCreateFortiGateAutoScalingGroup
                  - Outputs.AutoScalingGroupNamePayg
                - !GetAtt
                  - StackCreateFortiGateAutoScalingGroup
                  - Outputs.AutoScalingGroupNameByol
            payg-scaling-group-name: !GetAtt
                - StackCreateFortiGateAutoScalingGroup
                - Outputs.AutoScalingGroupNamePayg
            resource-tag-prefix: !Ref ResourceTagPrefix
            scaling-group-desired-capacity: !Ref FgtAsgDesiredCapacityPayg
            scaling-group-max-size: !Ref FgtAsgMaxSizePayg
            scaling-group-min-size: !Ref FgtAsgMinSizePayg
            sns-topic-arn: !Ref AutoscaleSNSTopic
            sync-recovery-count: !Ref SyncRecoveryCount
            terminate-unhealthy-vm: !If
                - IfTerminateUnhealthyVm
                - 'true'
                - 'false'
            transit-gateway-id: !If
                - IfRequireTransitGatewayIntegration
                - !GetAtt
                  - StackCreateTransitGatewayComponents
                  - Outputs.TransitGatewayId
                - n/a
            transit-gateway-route-table-inbound: !If
                - IfRequireTransitGatewayIntegration
                - !GetAtt
                  - StackCreateTransitGatewayComponents
                  - Outputs.TransitGatewayRouteTableInbound
                - n/a
            transit-gateway-route-table-outbound: !If
                - IfRequireTransitGatewayIntegration
                - !GetAtt
                  - StackCreateTransitGatewayComponents
                  - Outputs.TransitGatewayRouteTableOutbound
                - n/a
            transit-gateway-vpn-handler-name: !If
                - IfRequireTransitGatewayIntegration
                - !GetAtt
                  - StackCreateTransitGatewayVpnHandler
                  - Outputs.HandlerName
                - n/a
            vm-info-cache-time: 3600
            vpn-bgp-asn: !Ref BgpAsn
    StackConfigureFortiAnalyzerIntegrationService:
        Type: 'AWS::CloudFormation::Stack'
        Condition: IfIntegrateFortiAnalyzer
        Properties:
            Parameters:
                FazHandlerFunctionName: !GetAtt
                    - StackCreateFortiAnalyzerComponent
                    - Outputs.FazHandlerFunctionName
                FazHandlerFunctionArn: !GetAtt
                    - StackCreateFortiAnalyzerComponent
                    - Outputs.FazHandlerFunctionArn
                FazHandlerServiceFunctionName: !GetAtt
                    - StackCreateFortiAnalyzerComponent
                    - Outputs.FazHandlerServiceFunctionName
                FazHandlerServiceFunctionArn: !GetAtt
                    - StackCreateFortiAnalyzerComponent
                    - Outputs.FazHandlerServiceFunctionArn
            TemplateURL: !Sub
                - >-
                    https://${S3BucketName}.${S3SubDomain}${Region}.amazonaws.com/${S3KeyPrefix}templates/configure-fortianalyzer-service.template.yaml
                - S3SubDomain: !If
                      - IfInUSGovCloud
                      - s3-
                      - s3.
                  Region: !Ref 'AWS::Region'
                  S3BucketName: !Ref S3BucketName
                  S3KeyPrefix: !Ref S3KeyPrefix
            TimeoutInMinutes: 10
    StartFortiGateAutoScalingGroupService:
        Type: 'AWS::CloudFormation::CustomResource'
        Properties:
            ServiceToken: !GetAtt
                - StackCreateAutoScaleHandler
                - Outputs.FgtAsgHandlerServiceArn
            ServiceType: startAutoscale
        DependsOn:
            - SaveSettings
    StopFortiGateAutoScalingGroupService:
        Type: 'AWS::CloudFormation::CustomResource'
        Properties:
            ServiceToken: !GetAtt
                - StackCreateAutoScaleHandler
                - Outputs.FgtAsgHandlerServiceArn
            ServiceType: stopAutoscale
        DependsOn:
            - SaveSettings
            - StackCreateDynamoDBTable
    AutoscaleSNSTopic:
        Type: 'AWS::SNS::Topic'
        Properties:
            DisplayName: !Sub
                - 'FortiGate Autoscale (${UniqueId}) Notifications'
                - UniqueId: !Ref UniqueId
            TopicName: !Join
                - '-'
                - - !Ref ResourceTagPrefix
                  - fortigate-autoscale-notification-sns-topic
            Tags:
                - Key: ResourceGroup
                  Value: !Ref ResourceTagPrefix
    AutoscaleSNSSubscription:
        Type: 'AWS::SNS::Subscription'
        Properties:
            Endpoint: !Ref AutoscaleNotificationSubscriberEmail
            Protocol: email
            TopicArn: !Ref AutoscaleSNSTopic
Metadata:
    'AWS::CloudFormation::Interface':
        ParameterGroups:
            - Label:
                  default: Resource tagging configuration
              Parameters:
                  - ResourceTagPrefix
                  - CustomIdentifier
                  - UniqueId
            - Label:
                  default: Network configuration
              Parameters:
                  - VpcCidr
                  - VpcId
                  - PublicSubnet1
                  - PublicSubnet2
                  - PrivateSubnet1
                  - PrivateSubnet2
                  - PrivateSubnetRouteTable
            - Label:
                  default: FortiGate configuration
              Parameters:
                  - FortiGateInstanceType
                  - FortiOSVersion
                  - FortiGatePskSecret
                  - FortiGateAdminPort
                  - FortiGateAdminCidr
                  - KeyPairName
            - Label:
                  default: FortiGate auto scaling group configuration
              Parameters:
                  - FgtAsgDesiredCapacityByol
                  - FgtAsgMinSizeByol
                  - FgtAsgMaxSizeByol
                  - FgtAsgDesiredCapacityPayg
                  - FgtAsgMinSizePayg
                  - FgtAsgMaxSizePayg
                  - FgtAsgScaleOutThreshold
                  - FgtAsgScaleInThreshold
                  - PrimaryElectionTimeout
                  - GetLicenseGracePeriod
                  - FgtAsgHealthCheckGracePeriod
                  - FgtAsgCooldown
                  - LifecycleHookTimeout
            - Label:
                  default: Load balancing configuration
              Parameters:
                  - LoadBalancingTrafficProtocol
                  - LoadBalancingTrafficPort
                  - LoadBalancingHealthCheckThreshold
                  - InternalLoadBalancingOptions
                  - InternalTargetGroupHealthCheckPath
                  - InternalLoadBalancerDnsName
            - Label:
                  default: Failover management configuration
              Parameters:
                  - HeartBeatInterval
                  - HeartBeatLossCount
                  - HeartBeatDelayAllowance
            - Label:
                  default: Deployment resources configuration
              Parameters:
                  - S3BucketName
                  - S3KeyPrefix
        ParameterLabels:
            S3BucketName:
                default: S3 bucket name
            S3KeyPrefix:
                default: S3 resource folder
            ResourceTagPrefix:
                default: Resource tag prefix
            CustomIdentifier:
                default: Resource name prefix
            UniqueId:
                default: Unique ID
            VpcCidr:
                default: VPC CIDR
            PublicSubnet1:
                default: Autoscale subnet 1 ID
            PublicSubnet2:
                default: Autoscale subnet 2 ID
            PrivateSubnet1:
                default: Private subnet 1 ID
            PrivateSubnet2:
                default: Private subnet 2 ID
            PrivateSubnetRouteTable:
                default: Private subnet route table
            FortiGateInstanceType:
                default: Instance type
            FortiOSVersion:
                default: FortiOS version
            LifecycleHookTimeout:
                default: Instance lifecycle timeout
            FgtAsgCooldown:
                default: Scaling cooldown period
            FgtAsgDesiredCapacityByol:
                default: Desired capacity (BYOL)
            FgtAsgMinSizeByol:
                default: Minimum group size (BYOL)
            FgtAsgMaxSizeByol:
                default: Maximum group size (BYOL)
            FgtAsgDesiredCapacityPayg:
                default: Desired capacity (On-Demand)
            FgtAsgMinSizePayg:
                default: Minimum group size (On-Demand)
            FgtAsgMaxSizePayg:
                default: Maximum group size (On-Demand)
            FgtAsgHealthCheckGracePeriod:
                default: Health check grace period
            FgtAsgScaleInThreshold:
                default: Scale-in threshold
            FgtAsgScaleOutThreshold:
                default: Scale-out threshold
            FortiGateAdminPort:
                default: Admin port
            FortiGateAdminCidr:
                default: Admin CIDR block
            KeyPairName:
                default: Key pair name
            FortiGatePskSecret:
                default: FortiGate PSK secret
            PrimaryElectionTimeout:
                default: Primary election timeout
            HeartBeatInterval:
                default: Heart beat interval
            HeartBeatLossCount:
                default: Heart beat loss count
            HeartBeatDelayAllowance:
                default: Heart beat delay allowance
            LoadBalancingTrafficProtocol:
                default: Traffic protocol
            LoadBalancingTrafficPort:
                default: Traffic port
            LoadBalancingHealthCheckThreshold:
                default: Health check threshold
            InternalLoadBalancingOptions:
                default: Internal ELB options
            InternalTargetGroupHealthCheckPath:
                default: Health check path
            InternalLoadBalancerDnsName:
                default: Internal ELB DNS name
            GetLicenseGracePeriod:
                default: Get license grace period
Outputs:
    FgtLicensingModel:
        Description: >-
            The FortiGate licensing model in the Auto Scaling group(s) for the
            initial deployment of this stack. (Options: PAYG-Only, BYOL-Only,
            Hybrid)
        Value: !If
            - IfPAYGOnly
            - PAYG-Only
            - !If
              - IfBYOLOnly
              - BYOL-Only
              - Hybrid
    AutoscaleSNSTopicArn:
        Description: ARN of the FortiGate Autoscale notifications (SNS Topic)
        Value: !Ref AutoscaleSNSTopic
